apiVersion: v1
kind: Secret
metadata:
  name: rabbitmq
  namespace: roboshop
  labels:
    project: roboshop
    environmet: dev
    component: rabbitmq
    tire: database
type: Opaque
data: 
    RABBITMQ_DEFAULT_USER: "cm9ib3Nob3A="
    RABBITMQ_DEFAULT_PASS: "cm9ib3Nob3AxMjM="
---
apiVersion: v1
kind: Service
metadata:
  name: rabbitmq-headless
  namespace: roboshop
  labels:
    project: roboshop
    environmet: dev
    component: rabbitmq
    tire: database
spec:
  clusterIP: None
  selector:
    project: roboshop
    environmet: dev
    component: rabbitmq
    tire: database
  ports:
  - protocol: TCP
    port: 5672
    targetPort: 5672
---
apiVersion: v1
kind: Service
metadata: 
  name: rabbitmq
  namespace: roboshop
  labels:
    project: roboshop
    environmet: dev
    component: rabbitmq
    tire: database
spec:
  selector:
    project: roboshop
    environmet: dev
    component: rabbitmq
    tire: database
  ports:
  - protocol: TCP
    port: 5672
    targetPort: 5672
---

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
  namespace: roboshop
  labels:
    project: roboshop
    environmet: dev
    component: rabbitmq
    tire: database
spec:
  replica: 2
  serviceName: "rabbitmq-headless"
  selector:
    matchLabels:
      project: roboshop
      environmet: dev
      component: rabbitmq
      tire: database
  template:
    metadata:
      name: rabbitmq
      namespace: roboshop
      labels:
        project: roboshop
        environmet: dev
        component: rabbitmq
        tire: database
      spec:
        containers:
        - name: rabbitmq
          image: rabbitmq:3
          envFrom:
          - secretRef:
            name: rabbitmq
          volumeMounts:
          - name: rabbitmq-data
            mountpath: /var/lib/rabbitmq
    volumesPeersistanceClaim:
    - metadata:
        name: rabbitmq-data
      spec:
        accessModes: ["ReadWriteOnce"]
        strogeClassName: "roboshop-ebs"
        resource:
          request:
            stroge: 2Gi
